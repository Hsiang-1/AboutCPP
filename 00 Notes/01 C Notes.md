# C Language Notes

Hsiang SHU.   2021-8-1

---

## 001. char *str与char str[]的区别

C语言中没有特定的字符串类型，常用以下两种方式定义字符串：一种是字符数组，另一种是指向字符串的指针。

两种定义方法：

```c
char str[] = "happy";
char *str = "happy";
```

在修改字符串内容时的区别：

（1）使用字符串数组

```c
char str[20] = "hello";
str[0] = 'H';
printf("%s\n",str);
```

输出结果：

> Hello

（2）使用字符指针

```c
char *str = "hello";
str[0] = 'H';
printf("%s\n",str);
```

输出结果：

> （无打印信息输出）

可见，使用（1）方式定义的字符串其字符是可以修改的，使用（2）方式定义的字符串其字符是不可以修改的。（2）中可以成功编译和链接，但运行时可能会出现错误，我编译与运行的平台是window10平台，运行结果是无打印信息输出，在其他不同的平台运行可能会出现`段错误（Segment Fault）`或者写入位置错误。

这两种表示字符串的方式的主要区别是：

**字符串指针指向的内容是不可修改的，字符数组是可以修改的，即（2）方式定义的字符串保存在常量区，是不可更改的，（1）方式定义的字符串保存在全局数据区或栈区，是可修改的。***

若将这个过程放在函数中，结合局部变量和存储区等知识，可以发现：

```c
char* get_str(void)
{
　　char str[] = {"abcd"};
　　return str;
}
```

char str[] = {"abcd"};**定义了一个局部字符数组，尽管是数组，但它是一个局部变量，**返回它的地址肯定是一个已经释放了的空间的地址。此函数返回的是内部一个局部字符数组str的地址，且函数调用完毕后此数组被销毁，所以你返回的指针也就指向一块被销毁的内存，这种写法是错误的。

```c
char* get_str(void)
{
　　char *str = {"abcd"};
　　return str;
}
```

char* str = {"abcd"};**表示先定义个字符串常量，并将其地址赋给str。**此函数返回的是字符串常量的地址，而像这种字符串都是属于全局的，在编译的时候就已经分配了内存了，只有程序退出的时候才会被销毁，所以返回它的地址是没有问题的，但是你最好返回常量指针，因为你不能去改变字符串常量的值。

```c
char str[] = "abcd"; //sizeof(str) == 5 * sizeof(char)
char* str = "abcd"; //sizeof(str) == 4(x86) or 8(x64)
//sizeof(char) == 1
```

char* str是存储在全局静态存储区，所以虽然是局部变量，但函数返回后依然可以拿到正确的值！
char str[] 是存储在栈上的，local variable ，函数返回后，OS就收回空间了，就不复存在了，所以，拿不到正确的结果！

参考：

[【C语言笔记】char *str与char str[]的区别 ](https://cloud.tencent.com/developer/article/1450996)

[char str[] 与 char *str的区别详细解析](https://www.cnblogs.com/fenghuan/p/4865796.html)

---

## 002. C语言内存分配的方式

内存分配可分为三种：静态存储区、栈区、堆区。

1. `静态存储区`：该内存在程序编译的时候就已经分配好，这块内存在程序的整个运行期间都存在，它主要存放静态数据、全局数据和常量。
2. `栈区`：它的用途是完成函数的调用。在执行函数时，函数内局部变量及函数参数的存储单元在栈上创建，函数调用结束时这些存储单元自动被释放。
3. `堆区`：程序在运行时使用库函数为变量申请内存，在变量使用结束后再调用库函数释放内存。动态内存的生存期是由我们决定的，如果我们不释放内存，就会导致内存泄漏。

C语言一直由下面部分组成：

**正文段**（**code segment/text segment，.text段**）：或称代码段，通常是用来存放程序执行代码的一块内存区域。这部分区域的大小在程序运行前就已经确定，并且内存区域通常属于只读，某些架构也允许代码段为可写，即允许修改程序。在代码段中，也有可能包含一些只读的常数变量，例如字符串常量等。CPU执行的机器指令部分。

**数据段**（**data segment，.data段**）：通常是用来存放程序中已初始化的全局变量的一块内存区域。数据段属于静态内存分配。

**BSS段**（**bss segment，.bss段**）：通常是指用来存放程序中未初始化的全局变量的一块内存区域。BSS是英文Block Started by Symbol的简称。BSS段属于静态内存分配。

**堆**（**heap**）：堆是用于存放进程运行中被动态分配的内存段，它的大小并不固定，可动态扩张或缩减。当进程调用malloc等函数分配内存时，新分配的内存就被动态添加到堆上(堆被扩张)；当利用free等函数释放内存时，被释放的内存从堆上被剔除(堆被缩减)。

**栈**（**stack**）：栈又称堆栈，是用户存放程序临时创建的局部变量，也就是我们函数大括号"{}"中定义的变量(不包括static声明的变量)。除此以外，在函数被调用时，其参数也会被压入发起调用的进程栈中，并且等调用结束后，函数的返回值也会被存放在回栈中。由于栈的先进先出特性，所有栈特别方便用来保存/恢复调用现场。从这个意义上讲，把堆栈看成一个寄存、交换临时数据的内存区。

参考：

[C语言内存空间分布详解](https://blog.csdn.net/z215367701/article/details/75554242)

[C语言存储空间布局以及static解析](https://blog.csdn.net/Sharp_UP/article/details/77104906)

---

## 003. 



